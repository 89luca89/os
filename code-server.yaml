package:
  name: code-server
  version: "4.98.2"
  epoch: 0
  description: 
  copyright:
    - license: Apache-2.0
  resources:
    cpu: 32
    memory: 64Gi

environment:
  contents:
    packages:
      - bash
      - build-base
      - busybox
      - ca-certificates-bundle
      - coreutils
      - findutils
      - git
      - git-lfs
      - grep
      - nodejs-20
      - npm
      - node-gyp
      - python3
      - make
      - gcc
      - libx11-dev
      - libxkbcommon-dev
      - libsecret-dev
      - libxkbfile-dev
      - krb5-dev
      - jq
      - rsync

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/coder/code-server
      tag: v${{package.version}}
      expected-commit: e2c489dd00f163b1a8d959965b0c30c1a978a080

  - runs: |
      git submodule update --init
      cp ./patches/* .

  - uses: patch
    with:
      series: series

  - uses: patch
    with:
      patches: node-memory.patch

  - runs: | 
      ls -al .
      npm install
      npm run build
      VERSION=0.0.0 npm run build:vscode
      npm run release
      # npm run release:integration
      # npm run package

# subpackages:
#   - name: "${{package.name}}-compat"
#     dependencies:
#       runtime:
#         - ${{package.name}}
#     pipeline:
#       - runs: |
#           mkdir -p "${{targets.subpkgdir}}"/usr/local/bin
#           ln -s /usr/bin/vault-secrets-webhook ${{targets.subpkgdir}}/usr/local/bin/vault-secrets-webhook

# update:
#   enabled: true
#   github:
#     identifier: coder/code-server
#     strip-prefix: v
#     use-tag: true

# test:
#   environment:
#     contents:
#       packages:
#         - curl
#         - jq
#         - git
#         - wait-for-it
#     environment:
#       SECRET: root
#   pipeline:
#     - uses: test/kwok/cluster
#     - name: Test the app
#       runs: |